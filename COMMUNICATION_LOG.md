# COMMUNICATION LOG

依頼と対応の履歴を時系列でメモする。新しい項目は末尾に追記してください。

- 2025-12-02 23:55 「gitで基本設定して」→ git init、.gitignore/.gitattributes/AGENTS を追加し初回コミット。
- 2025-12-03 00:10 「波紋シミュレーション方針を検討」→ Computeベースの設計案を提示。
- 2025-12-03 00:32 「方針どおり実装＆インスペクタで確認したい」→ RippleCompute/スクリプト/カスタムインスペクタを実装しコミット。
- 2025-12-03 00:40 「コンパイルエラー修正」→ StateTexture の参照名を修正しコミット。
- 2025-12-03 00:48 「マウス離したらForceクリア＆プレビュー更新」→ マウス入力処理とエディタ更新を追加しコミット。
- 2025-12-03 00:55 「波が遅いので速く調整したい」→ waveSpeed上限拡大と timeScale 追加でスピード調整可能にしコミット。
- 2025-12-03 01:00 「Force軌跡を残さずその場だけ反映」→ 毎フレームForceをクリアし瞬間入力に変更しコミット。
- 2025-12-03 01:12 「マウスデバッグを別クラスに分離」→ RippleMouseDebug を新設し、RippleSimulation からマウス関連を分離しコミット。
- 2025-12-03 01:18 「Resultを任意RTへBlitで出力」→ outputTexture と autoBlit を追加し、サイズ差をBlitで吸収できるよう対応中。
- 2025-12-03 01:25 「波が減衰せず暴れる」→ Computeに振幅減衰パラメータを追加し、高さと速度に時間減衰を適用。
- 2025-12-03 01:32 「Result法線をZ+基準で青系に」→ 法線計算を (x,y,z)=(左右,上下,奥行) で z+ を基準にエンコードするよう変更。
- 2025-12-03 02:20 「波動方程式で多重波紋にしたい」→ Computeを中央差分の波動方程式へ置き換え、高さと前フレーム高さで2階時間微分を表現し、力を加えたときに多重の波紋が出るよう調整。
- 2025-12-03 02:36 「波が消えるときのチラつき」→ CFLクランプと微小粘性・ゼロクリップを追加し、高周波ノイズを抑制。
- 2025-12-03 02:50 「フレームレート非依存にしたい」→ RippleSimulation に固定タイムステップ/サブステップ方式を追加し、60fps相当で積み上げる可変＋固定ハイブリッドに対応。
- 2025-12-03 03:05 「パラメータ説明のREADMEが欲しい」→ README.md を作成し主要パラメータ・入力テクスチャを整理。
- 2025-12-03 03:25 「端の処理を選べるように」→ 水平方向/垂直方向それぞれ Bounce・Absorb・Wrap を選択できるように Compute/スクリプト/README を更新。
- 2025-12-03 03:35 「インスペクタに新パラメータが出ない」→ カスタムインスペクタに Edge モードと固定タイムステップ関連のプロパティを追加し、状態プレビューのラベルも更新。
- 2025-12-03 03:45 「Absorbでも反射する」→ 流れの逆流時も端処理を適用できるよう、エッジ処理関数を追加し clamping を廃止。Absorb/Warp/Bounce が正しく効くよう修正。
- 2025-12-03 04:10 「ResultRTから簡易コースティクス生成を実装して」→ CausticsHit.compute と CausticsAdd.shader、CausticsRenderer コンポーネントを追加し、Computeで反射先を算出して加算ブレンドで描画するパイプラインを実装。READMEに使い方を追記。
- 2025-12-03 04:25 「カメラ位置でコースティクス結果が変わる」→ CausticsAdd の頂点変換をクリップ空間直書きに変更し、描画がシーンカメラ行列に依存しないよう修正。
- 2025-12-03 04:45 「Quad の表裏で法線が逆」→ Unity Quad が -Z 向きであることに合わせ、Source/Target の法線を -forward で Compute に渡すよう修正し、法線ブレンドもその向きを基準に。
- 2025-12-03 05:00 「可視化用メッシュを自動生成し調整したい」→ CausticsRenderer を ExecuteAlways 化し、エディタ上で床/壁のQuadを自動生成・サイズ調整できるように追加。Transformのスケール・位置はそのまま利用し、法線は right×up で算出。
- 2025-12-03 05:15 「Play/StopでFloor/Wallが増える」→ 自動生成メッシュを名前で再利用し、OnDisableで安全に破棄する処理を追加して増殖を防止。
- 2025-12-03 19:51 「RayとPlaneの交点を返すCustomHLSLを追加して」→ VFX用HLSLを新規作成し、RayPlaneIntersection 関数を実装（Custom HLSL Operator 用に out を廃止し、距離を返す仕様に修正）。
- 2025-12-03 20:27 「direction を normal で反射したベクトルを返す関数を追加して」→ ReflectDirection を RayPlaneIntersection.hlsl に追加。
- 2025-12-03 20:30 「Caustics VFX Graph の可視化をコミット＆プッシュして」→ 現在の差分（CausticsVisalize.vfx、hamon.unity、RayPlaneIntersection.hlsl など）をコミットし push。
- 2025-12-04 17:41 RippleCompute デッドゾーンを緩和し、微小高さも伝搬するようノイズカットを削除
- 2025-12-04 17:57 MakeNormals 改善: Sobelで勾配平滑化、NormalNoiseThreshold削除（Compute/C#）
- 2025-12-04 18:04 RippleSimulationEditor NullReference対応: NormalNoiseThreshold関連のSerializedPropertyとInspector項目を削除
- 2025-12-04 19:10 ノーマル後処理追加: Sobel勾配スケール/ガウシアンぼかしを調整可能にし、BlurNormalsカーネルとRT追加（Compute/C#、Editor）
- 2025-12-04 19:13 RippleCompute 警告対応: uint/int比較を座標int変換後に判定しd3d11のsigned/unsigned warningを解消
- 2025-12-04 20:05 RTフォーマット変更: RippleSimulationのRTをFloat系に更新、VFX/Shader反映
- 2025-12-04 20:28 RippleMouseDebug 改修: MeshColliderにレイキャストしUVでRipple入力、スクリーン座標デバッグ廃止
- 2025-12-04 22:02 README更新: ノーマル調整パラメータ・FloatRT・RippleMouseDebug仕様を追記
- 2025-12-08 13:38 「ShaderGraph用コースティクス計算ノードを用意して」→ CausticsCustomNodes.hlsl を追加し、反射/屈折の平面交点とUV密度計算を実装
- 2025-12-08 13:43 「Custom Function Node の命名/精度規約に合わせて」→ CausticsCustomNodes.hlsl を precision suffix 付き関数に書き直し、float/half 両対応を追加
- 2025-12-08 13:47 「コースティクスマテリアルへライト/壁パラメータを渡すC#を作成して」→ CausticsMaterialBinder.cs を追加し、ライト種別・位置/方向、壁位置/法線、反射/屈折種別を MaterialPropertyBlock で設定する機能を実装
- 2025-12-08 13:50 「_WallNormal にプロパティ名を修正して」→ CausticsMaterialBinder.cs のシェーダープロパティ名を _WallNormal に修正
- 2025-12-08 13:55 「反射/屈折はノードで計算するのでHLSLはRay→Plane交差のみに」→ CausticsCustomNodes.hlsl を CausticsRayToPlane_* に簡素化し、rayOrigin/dir から hitPos/UV/mask を返す構成へ変更
- 2025-12-08 15:23 「デスクトップ想定なのでfloat精度だけに」→ CausticsCustomNodes.hlsl から half 版を削除し、float 精度の関数のみ残す構成に調整
- 2025-12-08 15:40 「壁法線を PlanePropertyBinder と合わせて transform.up に」→ CausticsMaterialBinder.cs の wallNormal 設定を forward から up に変更
- 2025-12-08 15:43 「Directional Light の向きコメントを確認・明記」→ CausticsMaterialBinder.cs のコメントを光線進行方向は -forward と明示する内容に更新
- 2025-12-08 16:05 「rUV ddx/ddy の精度限界対策案その2」→ CausticsCustomNodes.hlsl に解析ヤコビアンで足跡面積を求める CausticsRayFootprint_float を追加
- 2025-12-08 17:10 「ComputeShaderでフォトンスプラットするコンポーネントを追加」→ CausticsPhotonSplat.cs・CausticsPhotonSplat.compute・CausticsPhotonMesh.shader を追加し、テクスチャ解像度ベースのメッシュに密度を積算・描画する処理を実装
- 2025-12-08 20:27 「フォトンスプラットの警告/エラー修正」→ CausticsPhotonMesh.shader の色計算を修正し、CausticsPhotonSplat.compute のuint比較警告を解消
- 2025-12-08 21:05 「PhotonSplatはRTなしで直接加算描画に簡素化して」→ CausticsPhotonSplat.cs から RT 出力を廃止し、メッシュを直接 Additive 描画する構成に変更
- 2025-12-09 00:10 「PhotonSplatの生成メッシュをシーン保存しないように」→ CausticsPhotonSplat.cs で生成メッシュ/マテリアルに HideAndDontSave を設定し、Disable時にメッシュを破棄するように変更
- 2025-12-09 00:25 「方針をAGENTSに明記して」→ AGENTS.md に動的生成メッシュ/マテリアルは HideAndDontSave としシーン保存しない方針を追記
- 2025-12-09 00:45 「PhotonSplatを空間に配置する描画へ」→ CausticsPhotonMesh.shader をワールド空間スプラット描画に変更し、CausticsPhotonSplat.cs でターゲット平面座標系をシェーダーへ渡すよう更新
- 2025-12-09 01:05 「PhotonSplatを1枚のプレーンメッシュに統合」→ CausticsPhotonMesh.shader で解像度分割プレーン上の頂点強度を三角形面積で算出する方式に変更
- 2025-12-09 01:25 「メッシュを完全連結のプレーンに再構築」→ CausticsPhotonSplat.cs の BuildGridMesh を (w+1)*(h+1) 頂点の分割プレーン生成に変更し、分割境界が全て共有されるよう修正
- 2025-12-09 01:40 「頂点強度の分布を接続性重視に修正」→ CausticsPhotonMesh.shader で頂点ごとに接する4セルの平均密度×セル面積で強度を算出し、色計算が強度を乗算するよう修正
- 2025-12-09 12:30 Ripple Result をY-upワールド法線で出力するよう変更し、CausticsHit/PhotonSplatをワールド法線前提に更新、README/プレビュー表記を調整
- 2025-12-09 13:05 Ripple Result 法線を非パック(-1..1)で出力するよう変更し、CausticsHit/PhotonSplat/README等を合わせて更新
- 2025-12-09 13:25 Ripple Absorb エッジをクランプ継続挙動に変更し、READMEのエッジ説明を更新
- 2025-12-09 13:45 Ripple Absorb をミラー反射で連続させる挙動に更新（反対側へ伝搬しない）、README/コメントを更新
- 2025-12-09 14:00 Absorb をスポンジ減衰で反射しない仕様に変更し、README/コメントを更新
- 2025-12-09 14:20 Absorb の減衰幅を12pxに拡大し二乗フェード+ゼロクリップで吸収を強化、READMEを更新
- 2025-12-09 13:38 「コミットプッシュ依頼対応」→ 現在の差分（Ripple結果をワールド法線非パック化、Absorb境界をクランプ+スポンジ減衰化、Caustics Hit/PhotonSplat/PhotonMesh/VFX/ShaderGraph/READMEを更新）をコミットしpush。
- 2025-12-09 14:11 CausticsMeshRendererを追加。Rippleの解像度から(W+1,H+1)メッシュとGraphicsBuffer(Position/Intensity)を生成し、Mesh VBと共にVFXへバインドする処理を実装。
- 2025-12-09 14:37 CausticsMeshRenderer に PositionIntensityTexture (ARGBFloat, (W+1,H+1)) を生成し VFX へセットする処理を追加。
- 2025-12-09 14:51 CausticsMeshVfxHelpers.hlsl を追加。ParticleIDとグリッド(W,H)から(PositionIntensityTexture用に)ピクセル座標を計算し、pos/intensityを書き込むヘルパーを実装。
- 2025-12-09 15:02 CausticsMeshVfxHelpers.hlsl を VFX Custom HLSL Block 形式に変更（attributes を先頭引数、RWTexture2D/グリッド/強度/位置を引数にし PositionIntensityTexture へ書き込む関数を提供）。
- 2025-12-09 15:24 CausticsMeshVfxHelpers.hlsl に Position/Intensity を別タイミングで書ける関数を追加し、既存の同時書き込み関数はそれらを呼ぶ形に変更。
- 2025-12-09 15:33 CausticsMeshVfxHelpers.hlsl に PositionIntensityTexture から隣接セル面積を求め密度(1/面積平均)を返す CustomHLSL Operator 用関数 Caustics_ComputeIntensity を追加。
- 2025-12-09 16:48 HLSL フォルダ集約に伴い CausticsCustomNodes.hlsl の include パスを Shaders/HLSL 配下参照に修正。
- 2025-12-09 16:55 CausticsMeshVfxHelpers.hlsl から VFXCommon.hlsl include を削除し、VFX側の二重定義エラーを回避。
- 2025-12-09 16:57 CausticsMeshVfxHelpers.hlsl に gridSize省略の3引数版 WritePosition/WriteIntensity を追加し、RTサイズから分割数を推定するヘルパーを導入。VFXの3引数呼び出しエラーに対応。
- 2025-12-09 17:04 CausticsMeshVfxHelpers.hlsl の gridSize 推定で RWTexture2D 版を使用するよう置換し、VFX CustomHLSL 呼び出し時の型不一致を解消。
- 2025-12-09 17:30 CausticsMeshVfxHelpers.hlsl を再整理。uint2 版を内部関数にし、float2 gridSize 版のみ外部に残して再帰コンパイルエラーを解消。
- 2025-12-09 17:40 CausticsMeshVfxHelpers.hlsl で particleId を attributes から参照していた箇所をグローバル particleId を利用する形に変更し、Update Particle の invalid subscript エラーを回避。
- 2025-12-09 17:48 CausticsMeshVfxHelpers.hlsl で particleId を attributes.particleId 参照に戻し、未定義エラー対応。
- 2025-12-09 17:58 CausticsMeshVfxHelpers.hlsl を簡素化。_UInt 関数を削除し、公開関数内で直接 attributes.particleId を参照する形に変更して particleId 未使用エラーを解消。
- 2025-12-09 18:05 VFX Custom HLSL の注意点を VFXCustomHLSL_Tips.md にまとめ（シグネチャ一意化、attributes.particleId使用、UAV生成など）。
- 2025-12-09 18:42 VFXCustomHLSL_Tips.md を Assets 外 (docs/) に移動。
- 2025-12-09 18:50 CausticsMeshVfxHelpers.hlsl を単一関数 Caustics_WritePositionIntensity のみに簡素化（位置+強度をまとめて書き込み）。
- 2025-12-09 19:05 RippleSimulation を [ExecuteAlways] 化し、エディットモードでも出力RTが更新されプレビュー可能にした。
- 2025-12-09 19:20 README をVFX/ShaderGraphベースのコースティクス構成に更新（CausticsMeshRenderer+VFX+ShaderGraph推奨、既存Compute版はレガシー扱い）。
- 2025-12-10 13:31 「VFX Graph経由とComputeShader直呼びのコースティクス性能差を教えて」→ VFX Graphのオーバーヘッド/メリデメと計測指針を回答。
- 2025-12-10 13:36 「Compute版がなくなったのでドキュメント更新して」→ READMEからレガシー記述を削除し、VFX/ShaderGraph版のみが現行である旨を追記。
- 2025-12-17 10:58 「HamonInteractive をパッケージ化したい」→ Assets/HamonInteractive を `Packages/cc.sugi.water-ripple-caustics` に移動して Runtime/Editor/Samples~/Scenes を整理し、manifest・lock・README・docs を更新。
- 2025-12-18 01:04 「Forceデバッグが横長になる」→ Brushカーネルで横長解像度時にX方向をアスペクト補正し、Force入力が正円になるよう制御。
- 2025-12-18 01:26 「微小な波動でも伝搬してほしい」→ SimStep 内のデッドゾーン判定を削除し、わずかな高さ/速度でもそのまま波動として残るよう変更。
